---
import Layout from "@/layouts/Layout.astro";
import { Navbar } from "@/components/organisms/Navbar";
import { BlogCard } from "@/components/BlogCard";
import { FadeIn } from "@/components/FadeIn";
import { Footer } from "@/components/Footer";
import Parser from "rss-parser";

const parser = new Parser({
	customFields: {
		item: [["content:encoded", "contentEncoded"]],
	},
});

let posts: {
	title: string;
	link: string;
	pubDate: string;
	categories: string[];
	thumbnail: string;
	excerpt: string;
}[] = [];

try {
	const feed = await parser.parseURL(
		"https://medium.com/feed/@ravinder-chadha"
	);

	posts = (feed.items || []).map((item) => {
		const content = (item as any).contentEncoded || item.content || "";

		// Extract first image from content
		const imgMatch = content.match(/<img[^>]+src="([^"]+)"/);
		const thumbnail = imgMatch?.[1] || "https://placehold.co/800x450";

		// Strip HTML and get excerpt
		const stripped = content
			.replace(/<[^>]*>/g, "")
			.replace(/&nbsp;/g, " ")
			.trim();
		const excerpt = stripped.length > 200 ? stripped.slice(0, 200) + "..." : stripped;

		return {
			title: item.title || "Untitled",
			link: item.link || "#",
			pubDate: item.pubDate || new Date().toISOString(),
			categories: item.categories || [],
			thumbnail,
			excerpt,
		};
	});
} catch (e) {
	console.error("Failed to fetch Medium RSS feed:", e);
}
---

<Layout title="Blogs — Ravinder Chadha">
	<Navbar activePage="blogs" client:load />
	<main class="pt-20">
		<section class="px-6 md:px-8 py-24 md:py-32 max-w-5xl mx-auto">
			<FadeIn client:load>
				<p
					class="text-xs uppercase tracking-[0.2em] text-muted-foreground mb-4 font-medium"
				>
					Blogs
				</p>
				<h2
					class="text-3xl md:text-5xl font-bold tracking-tight text-foreground leading-tight max-w-2xl mb-4"
				>
					Thoughts on engineering, security &{" "}
					<em class="font-serif italic font-normal">open source.</em>
				</h2>
				<p class="text-base text-muted-foreground max-w-xl mb-16">
					Writing about things I learn along the way — from container
					security and distributed systems to Python tooling and developer
					workflows.
				</p>
			</FadeIn>

			{
				posts.length > 0 ? (
					<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
						{posts.map((post, i) => (
							<FadeIn client:visible delay={i * 100}>
								<BlogCard {...post} />
							</FadeIn>
						))}
					</div>
				) : (
					<FadeIn client:load>
						<div class="text-center py-20">
							<p class="text-muted-foreground text-lg">
								No blog posts found. Check back soon.
							</p>
						</div>
					</FadeIn>
				)
			}
		</section>
	</main>
	<Footer client:visible />
</Layout>
